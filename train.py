from fastdownload import download_url
from pathlib import Path

from zipfile import ZipFile

from sklearn.metrics import accuracy_score
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split

import pandas as pd
import os

import mlflow
from mlflow.models.signature import infer_signature
from mlflow.client import MlflowClient
from mlflow.entities import ViewType

from hyperopt import STATUS_OK, Trials, hp, tpe, fmin
from hyperopt.pyll import scope

from prefect import flow, task

os.environ["AWS_PROFILE"] = "default" # fill in with your AWS profile. More info: https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/setup.html#setup-credentials

TRACKING_SERVER_HOST = "ec2-54-198-84-151.compute-1.amazonaws.com" # fill in with the public DNS of the EC2 instance


DOWNLOAD_DATASET = False
EXP_NAME = "Experiment-1"
MODEL_NAME ="malware-detector"


def map_cols(df):
    cols = [i for i in df.columns]
    mapping = {col:i for i,col in enumerate(cols) if col != "Result"}
    return mapping

def create_data_fld(fldname: str) -> Path:
    data_path = Path(fldname)
    if not data_path.exists():
        data_path.mkdir(exist_ok=True)
    return data_path

@task
def download_data(data_path : Path) -> None:
    '''download android malware detection data and save it in data_path'''
    url = "https://archive.ics.uci.edu/static/public/722/naticusdroid+android+permissions+dataset.zip"
    download_url(url, dest=data_path)

def unzip(zip_file : str, out_path : Path):
    zip_file_obj = ZipFile(zip_file)
    zip_file_obj.extractall(path=out_path)
    zip_file_obj.close()


def preprocess(data_file : Path):

    df = pd.read_csv(data_file)
    mapper = map_cols(df)
    df=df.rename(columns=mapper)
    
    df.astype(float)
    
    X,y = df.drop("Result", axis=1), df["Result"]
    X_train, X_val, y_train, y_val = train_test_split(X,y, test_size=0.2,  random_state=42)
    return X_train, X_val, y_train, y_val

@task
def get_best_params(X,y,X_val,y_val):
    """hypyer parameter tuning for RandomForestClassifier"""
    def objective(params):
        with mlflow.start_run() as run:
            mlflow.set_tag("Developer", "Shane")
            mlflow.log_params(params)
            m = RandomForestClassifier(**params)
            m.fit(X,y)
            y_preds = m.predict(X_val)
            accuracy = accuracy_score(y_val, y_preds)
            mlflow.log_metric('Accuracy', accuracy)
            
        return {"loss": -accuracy, 'status' : STATUS_OK}
    
    search_space = {'n_estimators':scope.int(hp.uniform('n_estimators',100,500)),
               'max_depth':scope.int(hp.uniform('max_depth',5,20)),
               'min_samples_leaf':scope.int(hp.uniform('min_samples_leaf',1,5)),
               'min_samples_split':scope.int(hp.uniform('min_samples_split',2,6))}
    
    best_params = fmin(
        fn=objective,
        space=search_space,
        algo=tpe.suggest,
        max_evals=5,
        trials=Trials(),
    )

    return best_params

@task
def prepare_data():
    data_path = create_data_fld('data')

    if DOWNLOAD_DATASET:
        download_data(data_path)

    data_file = data_path.joinpath('data.csv')
    X_train, X_val, y_train, y_val = preprocess(data_file)

    return X_train, X_val, y_train, y_val

@task
def train_best_model(params : dict,X,y,X_val,y_val)-> str:
    with mlflow.start_run() as run:
        mlflow.set_tag("Developer", "Shane")
        mlflow.log_params(params)
        m = RandomForestClassifier(**params)
        m.fit(X,y)
        y_preds = m.predict(X_val)
        accuracy = accuracy_score(y_val, y_preds)
        mlflow.log_metric('Accuracy', accuracy)
        signature = infer_signature(X_val, y_preds)
        mlflow.sklearn.log_model(m, artifact_path="model", signature=signature)

@task
def register_model(run_id:str):
    mlflow.set_tracking_uri(f"http://{TRACKING_SERVER_HOST}:5000")
    model_uri = f"runs:/{run_id}/model"
    mlflow.register_model(model_uri=model_uri, name=MODEL_NAME)

def get_best_model_run_id():
    client = MlflowClient(tracking_uri=f"http://{TRACKING_SERVER_HOST}:5000")
    experiment = client.get_experiment_by_name(EXP_NAME)
    best_model_meta_data=mlflow.search_runs(
        experiment_ids=experiment.experiment_id,
        run_view_type=ViewType.ACTIVE_ONLY,
        order_by=["metrics.Accuracy DESC"],
        max_results=1,
        )
    return best_model_meta_data.run_id[0]

@flow(name="Training Pipeline")
def main():

    mlflow.set_tracking_uri(f"http://{TRACKING_SERVER_HOST}:5000")
    mlflow.set_experiment(EXP_NAME)
    
    X_train, X_val, y_train, y_val= prepare_data()
    
    best_params = get_best_params(X_train,y_train,X_val,y_val)
    best_params = {k:int(v) for k,v in best_params.items()}
    print(best_params)
    train_best_model(best_params,X_train,y_train,X_val,y_val)
    run_id = get_best_model_run_id()
    register_model(run_id)
    

if __name__ == "__main__":
    main()