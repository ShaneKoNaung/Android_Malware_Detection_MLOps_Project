from fastdownload import download_url
from pathlib import Path

from zipfile import ZipFile

from sklearn.metrics import accuracy_score
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split

import pandas as pd

import mlflow
from mlflow.models.signature import infer_signature

from hyperopt import STATUS_OK, Trials, hp, tpe, fmin
from hyperopt.pyll import scope

DOWNLOAD_DATASET = False
BACKEND_STORE_URI = "mlruns"
EXP_NAME = "Experiment-1"
MODEL_NAME ="malware-detector"


def create_data_fld(fldname: str) -> Path:
    data_path = Path(fldname)
    if not data_path.exists():
        data_path.mkdir(exist_ok=True)
    return data_path

def download_data(data_path : Path) -> None:
    '''download android malware detection data and save it in data_path'''
    url = "https://archive.ics.uci.edu/static/public/722/naticusdroid+android+permissions+dataset.zip"
    download_url(url, dest=data_path)

def unzip(zip_file : str, out_path : Path):
    zip_file_obj = ZipFile(zip_file)
    zip_file_obj.extractall(path=out_path)
    zip_file_obj.close()

def preprocess(data_file : Path):
    df = pd.read_csv(data_file)
    X,y = df.drop("Result", axis=1), df["Result"]
    X_train, X_val, y_train, y_val = train_test_split(X,y, test_size=0.2,  random_state=42)
    return X_train, X_val, y_train, y_val

def get_best_params(X,y,X_val,y_val):
    """hypyer parameter tuning for RandomForestClassifier"""
    def objective(params):
        with mlflow.start_run() as run:
            mlflow.set_tag("Developer", "Shane")
            mlflow.log_params(params)
            m = RandomForestClassifier(**params)
            m.fit(X,y)
            y_preds = m.predict(X_val)
            accuracy = accuracy_score(y_val, y_preds)
            mlflow.log_metric('Accuracy', accuracy)
            
        return {"loss": -accuracy, 'status' : STATUS_OK}
    
    search_space = {'n_estimators':scope.int(hp.uniform('n_estimators',100,500)),
               'max_depth':scope.int(hp.uniform('max_depth',5,20)),
               'min_samples_leaf':scope.int(hp.uniform('min_samples_leaf',1,5)),
               'min_samples_split':scope.int(hp.uniform('min_samples_split',2,6))}
    
    best_params = fmin(
        fn=objective,
        space=search_space,
        algo=tpe.suggest,
        max_evals=5,
        trials=Trials(),
    )

    return best_params

def train_best_model(params : dict,X,y,X_val,y_val)-> str:
    with mlflow.start_run() as run:
        mlflow.set_tag("Developer", "Shane")
        mlflow.log_params(params)
        m = RandomForestClassifier(**params)
        m.fit(X,y)
        y_preds = m.predict(X_val)
        accuracy = accuracy_score(y_val, y_preds)
        mlflow.log_metric('Accuracy', accuracy)
        signature = infer_signature(X_val, y_preds)
        run_id = mlflow.sklearn.log_model(m, artifact_path="models", signature=signature).run_id
        
    return run_id

def register_model(run_id:str):
    mlflow.set_tracking_uri(BACKEND_STORE_URI)
    model_uri = f"runs:/{run_id}/models"
    mlflow.register_model(model_uri=model_uri, name=MODEL_NAME)


def prepare_data():
    data_path = create_data_fld('data')

    if DOWNLOAD_DATASET:
        download_data(data_path)

    data_file = data_path.joinpath('data.csv')
    X_train, X_val, y_train, y_val = preprocess(data_file)

    return X_train, X_val, y_train, y_val

def main():

    mlflow.set_tracking_uri(BACKEND_STORE_URI)
    mlflow.set_experiment(EXP_NAME)
    
    X_train, X_val, y_train, y_val= prepare_data()
    
    best_params = get_best_params(X_train,y_train,X_val,y_val)
    best_params = {k:int(v) for k,v in best_params.items()}
    run_id=train_best_model(best_params,X_train,y_train,X_val,y_val)
    register_model(run_id)

if __name__ == "__main__":
    main()