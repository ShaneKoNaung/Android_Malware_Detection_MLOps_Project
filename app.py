from fastapi import FastAPI
from pydantic import BaseModel
import mlflow
import logging
import pickle
import pandas as pd

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

USE_LOCAL=True
RUN_ID = "cd55824e581f4cefba3b5adf56cab280"


def load_model_from_registry_local(run_id):
    
    logged_model = f'runs:/{run_id}/model'
    model = mlflow.pyfunc.load_model(logged_model)
    return model

def load_model_from_registry():
    # RUN_ID = os.getenv('RUN_ID')

    logged_model = f's3://mlflow-artifacts-android-malware/1/{RUN_ID}/artifacts/model'
    model = mlflow.pyfunc.load_model(logged_model)
    return model

def load_model_local():
    

    model = pickle.load(open("models/model.pickle", 'rb'))
    return model

def load_mapper():
    with open("models/mapper.pickle", "rb") as input_file:
        mapper = pickle.load(input_file)
    return mapper

def preprocess_features(input: dict):
    mapper = load_mapper()
    mapped_input = {mapper[k]:v for k,v in input.items()}
    return mapped_input

class Input_Obj(BaseModel):
    androidpermissionGET_ACCOUNTS: int
    comsonyericssonhomepermissionBROADCAST_BADGE: int
    androidpermissionREAD_PROFILE: int
    androidpermissionMANAGE_ACCOUNTS: int
    androidpermissionWRITE_SYNC_SETTINGS : int
    androidpermissionREAD_EXTERNAL_STORAGE: int
    androidpermissionRECEIVE_SMS: int
    comandroidlauncherpermissionREAD_SETTINGS: int
    androidpermissionWRITE_SETTINGS : int
    comgoogleandroidprovidersgsfpermissionREAD_GSERVICES: int
    androidpermissionDOWNLOAD_WITHOUT_NOTIFICATION: int
    androidpermissionGET_TASKS: int
    androidpermissionWRITE_EXTERNAL_STORAGE: int
    androidpermissionRECORD_AUDIO: int
    comhuaweiandroidlauncherpermissionCHANGE_BADGE: int
    comoppolauncherpermissionREAD_SETTINGS: int
    androidpermissionCHANGE_NETWORK_STATE: int
    comandroidlauncherpermissionINSTALL_SHORTCUT: int
    androidpermissionandroidpermissionREAD_PHONE_STATE: int
    androidpermissionCALL_PHONE: int
    androidpermissionWRITE_CONTACTS: int
    androidpermissionREAD_PHONE_STATE: int
    comsamsungandroidproviderscontextpermissionWRITE_USE_APP_FEATURE_SURVEY: int
    androidpermissionMODIFY_AUDIO_SETTINGS: int
    androidpermissionACCESS_LOCATION_EXTRA_COMMANDS: int
    androidpermissionINTERNET: int
    androidpermissionMOUNT_UNMOUNT_FILESYSTEMS: int
    commajeurlauncherpermissionUPDATE_BADGE: int
    androidpermissionAUTHENTICATE_ACCOUNTS: int
    comhtclauncherpermissionREAD_SETTINGS: int
    androidpermissionACCESS_WIFI_STATE: int
    androidpermissionFLASHLIGHT: int
    androidpermissionREAD_APP_BADGE: int
    androidpermissionUSE_CREDENTIALS: int
    androidpermissionCHANGE_CONFIGURATION: int
    androidpermissionREAD_SYNC_SETTINGS: int
    androidpermissionBROADCAST_STICKY: int
    comanddoeslauncherpermissionUPDATE_COUNT: int
    comandroidalarmpermissionSET_ALARM: int
    comgoogleandroidc2dmpermissionRECEIVE: int
    androidpermissionKILL_BACKGROUND_PROCESSES: int
    comsonymobilehomepermissionPROVIDER_INSERT_BADGE: int
    comsecandroidproviderbadgepermissionREAD: int
    androidpermissionWRITE_CALENDAR: int
    androidpermissionSEND_SMS: int
    comhuaweiandroidlauncherpermissionWRITE_SETTINGS: int
    androidpermissionREQUEST_INSTALL_PACKAGES: int
    androidpermissionSET_WALLPAPER_HINTS: int
    androidpermissionSET_WALLPAPER: int
    comoppolauncherpermissionWRITE_SETTINGS: int
    androidpermissionRESTART_PACKAGES: int
    meeverythingbadgerpermissionBADGE_COUNT_WRITE: int
    androidpermissionACCESS_MOCK_LOCATION: int
    androidpermissionACCESS_COARSE_LOCATION: int
    androidpermissionREAD_LOGS: int
    comgoogleandroidgmspermissionACTIVITY_RECOGNITION: int
    comamazondevicemessagingpermissionRECEIVE: int
    androidpermissionSYSTEM_ALERT_WINDOW: int
    androidpermissionDISABLE_KEYGUARD: int
    androidpermissionUSE_FINGERPRINT: int
    meeverythingbadgerpermissionBADGE_COUNT_READ: int
    androidpermissionCHANGE_WIFI_STATE: int
    androidpermissionREAD_CONTACTS: int
    comandroidvendingBILLING: int
    androidpermissionREAD_CALENDAR: int
    androidpermissionRECEIVE_BOOT_COMPLETED: int
    androidpermissionWAKE_LOCK: int
    androidpermissionACCESS_FINE_LOCATION: int
    androidpermissionBLUETOOTH: int
    androidpermissionCAMERA: int
    comandroidvendingCHECK_LICENSE: int
    androidpermissionFOREGROUND_SERVICE: int
    androidpermissionBLUETOOTH_ADMIN: int
    androidpermissionVIBRATE: int
    androidpermissionNFC: int
    androidpermissionRECEIVE_USER_PRESENT: int
    androidpermissionCLEAR_APP_CACHE: int
    comandroidlauncherpermissionUNINSTALL_SHORTCUT: int
    comsecandroidiappermissionBILLING: int
    comhtclauncherpermissionUPDATE_SHORTCUT: int
    comsecandroidproviderbadgepermissionWRITE: int
    androidpermissionACCESS_NETWORK_STATE: int
    comgoogleandroidfinskypermissionBIND_GET_INSTALL_REFERRER_SERVICE: int
    comhuaweiandroidlauncherpermissionREAD_SETTINGS: int
    androidpermissionREAD_SMS: int
    androidpermissionPROCESS_INCOMING_CALLS: int

class Output(BaseModel):
    is_malware : bool

app = FastAPI()


if USE_LOCAL:
    model = load_model_local()
if not USE_LOCAL:
    model = load_model_from_registry()

@app.get("/ping")
def ping():
    return {"ping" : "ok"}

@app.post("/predict", response_model=Output)
def predict(payload : Input_Obj):
    logger.info(payload)
    input = preprocess_features(payload.dict())
    prediction = model.predict(pd.DataFrame(input, index=[0]))
    response = {"is_malware" : bool(prediction)}

    return response
